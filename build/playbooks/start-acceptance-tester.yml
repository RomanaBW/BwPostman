---
- hosts: localhost
  become: true
  become_user: romana
  vars_files:
    - vars/vars.yml
    - vars/tests.yml
    - vars/vault.yml

  tasks:
    - name: Setup tester VM by vagrant up
      command: 'vagrant up {{ test_suite }}'
      args:
        chdir: '/vms-uni2/vagrant/infrastructure/farm1/J-Tester'
      delegate_to: 'localhost'

#    - name: Ensure inventory folder is present
#      become: true
#      become_user: romana
#      file:
#        path: "inventory"
#        state: directory
#
    - name: Set variable for filename
      set_fact:
        filename: "/vms-uni2/vagrant/infrastructure/farm1/J-Tester/files/{{ test_suite }}-ip.txt"

    - name: display IP of gererated VM (file content)
      debug:
        msg: "{{ lookup ('file', '{{ filename }}') }}"
      register: bw_tester_ip

    - name: Set variable for ip
      set_fact:
        tester_ip: "{{ bw_tester_ip.msg }}"

    - name: display IP of fact
      debug:
        msg: "{{ hostvars['localhost']['tester_ip'] }}"

    - name: Ensure inventory is created and equipped with the correct values
      become: true
      become_user: root
      template:
        src: "hosts.j2"
        dest: "inventory/hosts"

    - name: Refresh inventory
      meta: refresh_inventory

    - name: ensure log folder for test results exists
      become: true
      become_user: root
      file:
        path: "{{ test_log_path }}"
        state: directory
        mode: 0777

- hosts: "{{ test_suite }}"
  become: true
  become_user: romana
  vars_files:
    - vars/vars.yml
    - vars/tests.yml
    - vars/vault.yml

  tasks:
    - name: Set project dir variable
      set_fact:
        bw_project_base_dir: "{{ project_base_dir | default('/data/repositories/BwPostman/') }}"

    - name: copy tests
      copy:
        src: "{{ project_workspace }}/tests/"
        dest: "/data/tests"
        mode: 0775

    - name: remove AcceptanceTesterActions.php
      file:
        path: "/data/tests/_support/_generated/AcceptanceTesterActions.php"
        state: absent

    - name: Prepare manifest for codeception tests
      become: true
      become_user: root
      template:
        src: "codeception.yml.j2"
        dest: "/data/codeception.yml"

    - name: Prepare manifest for acceptance tests
      become: true
      become_user: root
      template:
        src: "acceptance.suite.yml.j2"
        dest: "/data/tests/acceptance.suite.yml"

    - name: Create test script
      template:
        src: "do-tests.sh.j2"
        dest: "/data/do-tests.sh"
        mode: 0775
