networks:
  push-net.nil:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.118.5.8/29

services:
  push-db:
    image: universe3:5000/romana/bwpm-base-tables:7.4.0-4.4.4
    container_name: push4-db
    restart: no
    networks:
      push-net.nil:
        ipv4_address: 172.118.5.10
    environment:
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MARIADB_DATABASE: joomlatest
      MARIADB_USER: tester
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
    expose:
      - 3303
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--datadir=/var/lib/mariadb", "--connect"]
      start_period: 50s
      interval: 10s
      timeout: 5s
      retries: 3

  push-web:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
    container_name: push4-web
    ports:
      - 79:80
    restart: no
    healthcheck:
      test: curl --fail http://172.118.5.11/index.php || exit 1
      start_period: 5s
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      push-net.nil:
        ipv4_address: 172.118.5.11
    depends_on:
      push-db:
        condition: service_healthy
    environment:
      JOOMLA_DB_PASSWORD: barbamama
      JOOMLA_DB_PASSWORD_FILE: /run/secrets/db_password
      JOOMLA_ADMIN_PASSWORD_FILE: /run/secrets/j_root_password
    volumes:
      # mount Joomla configuration
      - type: bind
        source: /home/romana/PhpstormProjects/BwPostman_J4/build/docker/push4/configuration.php
        target: /var/www/html/configuration.php

  push-phpmyadmin:
    image: phpmyadmin
    container_name: push4-phpmyadmin
    restart: always
    networks:
      push-net.nil:
        ipv4_address: 172.118.5.13
    expose:
      - 6379
    depends_on:
      push-db:
        condition: service_healthy
    environment:
      PMA_HOST: db
    healthcheck:
      #    See https://stackoverflow.com/questions/67904609/how-do-you-perform-a-healthcheck-in-the-redis-docker-image
      test: curl --fail http://172.118.5.13/LICENSE || exit 1
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3

secrets:
  db_password:
    file: ../../mariadb/db_password.txt
  db_root_password:
    file: ../../mariadb/db_root_password.txt
  j_root_password:
    file: ../j_root_password.txt
