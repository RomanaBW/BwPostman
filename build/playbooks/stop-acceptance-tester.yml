---
- hosts: localhost
  become: true
  become_user: romana
  vars_files:
  - vars/tests.yml

  tasks:
    - name: Shutdown tester machine
      command: 'vagrant halt {{ test_suite }}'
      args:
        chdir: '/vms-uni2/vagrant/infrastructure/farm1/J-Tester'

    - name: Remove tester machine
      command: 'vagrant destroy {{ test_suite }}'
      args:
        chdir: '/vms-uni2/vagrant/infrastructure/farm1/J-Tester'

    - name: check state of failed file
      stat:
        path: "/repositories/artifacts/bwpostman/logs/j{{ joomla_version }}_bwpm{{ bwpm_version }}/failed"
      register: failed_state

    - name: throw error if failed file exists
      fail:
        msg: "{{ test_suite }} failed!"
      when: failed_state.stat.exists == True
