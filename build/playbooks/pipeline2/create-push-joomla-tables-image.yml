---
- hosts: Arbeitsplatz
  connection: local
  gather_facts: no
  vars_files:
    - vars/fast-test-vars.yml

  tasks:
    # Synchronize var files to repo before used by following playbook and tasks
    - name: Synchronize needed vars files to repo
      become: yes
      synchronize:
        src: "{{ test_project_base_dir }}/build/playbooks/"
        dest: "{{ repo_dir }}/build/playbooks"
        delete: yes
        archive: yes
        partial: yes
        rsync_opts:
          - "--update"
          - "--quiet"

- hosts: tester
  gather_facts: no
  vars_files:
    - vars/tester-test-vars.yml
    - vars/tester-image-vars.yml

  tasks:
    - name: Make the base image available locally
      docker_image:
        name: '{{ private_docker_repo }}/{{ bare_source.db_image_tag_source }}'
        source: pull
        force_source: yes

    - name: Create the container
      docker_container:
        image: '{{ private_docker_repo }}/{{ bare_source.db_image_tag_source }}'
        name: "{{ bare_source.db_container_name }}"
        detach: yes

- hosts: "{{ bare_source.db_container_name }}"
  connection: docker
  gather_facts: no

  vars_files:
    - vars/tester-test-vars.yml
    - vars/tester-image-vars.yml
  vars:
    ansible_remote_tmp: "/tmp"

  tasks:
    - name: Debug ansible tmp path
      debug:
        msg: ansible_remote_tmp

    - name: copy Joomla tables to database container
      include_role:
        name: romanabw.copy-joomla-tables-to-database-container

- hosts: localhost
  pre_tasks:
    - include_vars: "vars/codecept_paths_J{{ j_master_version }}.yml"
  connection: local
  vars_files:
    - vars/tester-test-vars.yml
    - vars/tester-image-vars.yml

  tasks:
    - name: Commit the container
      command: 'docker commit -a "{{ author }}" {{ bare_source.db_container_name }} {{ private_docker_repo }}/{{ bare_target.db_image_tag_target }}'

    - name: Push container image to private registry
      shell: "docker push {{ private_docker_repo }}/{{ bare_target.db_image_tag_target }}"
      ignore_errors: true

    - name: Remove the container
      docker_container:
        name: "{{ bare_source.db_container_name }}"
        state: absent

