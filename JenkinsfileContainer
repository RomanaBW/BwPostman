pipeline {
    agent { label 'Tester' }

    stages {
        stage('Set variables for php 8 part') {
			steps {
				script {
					BWPM_VERSION = "4.1.5"

//					Stable
//					JOOMLA_VERSION = "4.2.9"
//					RC
					JOOMLA_VERSION = "4.3.0-rc2"

					PHP_VERSION = "8.1.12"

					GIT_MESSAGE = "not specified"

					PROJECT_NAME = "j${JOOMLA_VERSION}_bwpm${BWPM_VERSION}"
					VERSIONS_EXTRA_VAR_4 = "joomla_version=${JOOMLA_VERSION} bwpm_version=${BWPM_VERSION} php_selected_version=${PHP_VERSION}";
					DO_RECORD_SMOKE = "true";
					DO_RECORD_1 = "false";
					DO_RECORD_2 = "false";
					DO_RECORD_3 = "false";
					DO_RECORD_4 = "true";
					DO_RECORD_5 = "false";
					DO_RECORD_6 = "false";
					DO_RECORD_7 = "false";
				}
			}
        }

		stage('Create full package') {
			steps {
				sh "ansible-playbook -i ${WORKSPACE}/build/playbooks/pipeline2/inventory/hosts ${WORKSPACE}/build/playbooks/build_package.yml --extra-vars 'project_base_dir=${WORKSPACE} version_number=${BWPM_VERSION} build=${BUILD_NUMBER} mb4_support=true replace_vars=true'"
			}
		}

		stage('Run smoke tests with php 8') {
			steps {
//				echo "Dummy Smoke"
				sh "ansible-playbook -i ${WORKSPACE}/build/playbooks/pipeline2/inventory/hosts ${WORKSPACE}/build/playbooks/pipeline2/run-smoke-tests.yml --extra-vars 'project_base_dir=${WORKSPACE} do_record=${DO_RECORD_SMOKE} ${VERSIONS_EXTRA_VAR_4}'"
				sh "docker exec -t bwpm_enh_tester-4 /data/do-tests.sh ${BWPM_VERSION}"
				sh "ansible-playbook -i ${WORKSPACE}/build/playbooks/pipeline2/inventory/hosts ${WORKSPACE}/build/playbooks/pipeline2/push-smoke-testers.yml --extra-vars '${VERSIONS_EXTRA_VAR_4}'"
			}
			post {
					always {
					echo "Dummy Smoke ALWAYS"
//					sh "ansible-playbook -i ${WORKSPACE}/build/playbooks/pipeline2/inventory/hosts ${WORKSPACE}/build/playbooks/pipeline2/stop-smoke-tests.yml --extra-vars '${VERSIONS_EXTRA_VAR_4}'"
				}
				failure {
					bwpmAcceptFailureContainer ("Smoke", "${PROJECT_NAME}")
				}
			}
		}



//		stage('Push to github') {
//			steps {
//				echo "Push to github"
//			}
//		}

	}
}

