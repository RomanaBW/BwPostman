---
- hosts: localhost
  vars_files:
    - vars/container-vars.yml

  tasks:
    - name: Remove folders and files which are not needed
      file:
        path: "{{ project_base_dir }}/src/{{ item }}"
        state: absent
      with_items: "{{ to_delete }}"

    - name: Debug suites variable
      debug:
        msg: "{{ Suites }}"

    - name: create dirs for webserver files
      file:
        path: "{{ project_base_dir }}/container_files/files-{{ item.suite_number }}"
        state: directory
      with_items: "{{ Suites }}"

    - name: copy database dump
      synchronize:
        src: "{{ web_dir }}/{{ project_name }}/backups/"
        dest: "{{ project_base_dir }}/container_files/backups"

    - name: copy webserver files to webserver 1
      synchronize:
        src: "{{ web_dir }}/{{ project_name }}/files"
        dest: "{{ project_base_dir }}/container_files/files-1"

    - name: copy checked out extension files from to webserver 1
      synchronize:
        src: "{{ project_base_dir }}/src"
        dest: "{{ project_base_dir }}/container_files/files-1"

    - name: copy tests to webserver 1
      synchronize:
        src: "{{ project_base_dir }}/tests/"
        dest: "{{ project_base_dir }}/container_files/files-1/tests"

    - name: remove AcceptanceTesterActions.php
      file:
        path: "{{ project_base_dir }}/container_files/files-1/tests/_support/_generated/AcceptanceTesterActions.php"
        state: absent

    - name: copy webserver files from webserver 1 to webserver 2
      synchronize:
        src: "{{ project_base_dir }}/container_files/files-1/"
        dest: "{{ project_base_dir }}/container_files/files-2"

    - name: copy webserver files from webserver 1 to webserver 3
      synchronize:
        src: "{{ project_base_dir }}/container_files/files-1/"
        dest: "{{ project_base_dir }}/container_files/files-3"

    - name: ensure log folder for test results exists
      file:
        path: "/repositories/artifacts/bwpostman/{{ project_name }}/{{ item.name }}/logs"
        state: directory
        mode: 0777
      with_items: "{{ test_suites_container }}"

    - name: ensure video folder for test results exists
      file:
        path: "/repositories/artifacts/bwpostman/{{ project_name }}/{{ item.name }}/videos"
        state: directory
        mode: 0777
      with_items: "{{ test_suites_container }}"

    - name: Prepare manifest for codeception tests
      template:
        src: "codeception.container.yml.j2"
        dest: "{{ project_base_dir }}/container_files/files-{{ item.suite_number }}/codeception.yml"
      with_items: "{{ Suites }}"

    - name: Prepare manifest for acceptance tests
      template:
        src: "acceptance.suite.container.yml.j2"
        dest: "{{ project_base_dir }}/container_files/files-{{ item.suite_number }}/tests/acceptance.suite.yml"
      with_items: "{{ Suites }}"

    - name: Create test script
      template:
        src: "do-container-tests.sh.j2"
        dest: "{{ project_base_dir }}/container_files/files-{{ item.suite_number }}/do-container-tests.sh"
        mode: 0775
      with_items: "{{ Suites }}"

    #    sh "sudo chown -R romana ${WORKSPACE}/container_files/files-1"
#    sh "sudo chgrp -R jenkins ${WORKSPACE}/container_files/files-1"
#    sh "sudo chmod -R 0775 ${WORKSPACE}/container_files/files-1"

