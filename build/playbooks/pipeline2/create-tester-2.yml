---
# Attention: This playbook has to be run at the target machine, where the container runs!
# This playbook only works correctly at server. Other machines as host for this playbook don't get internet connection!

- hosts: localhost
  gather_facts: no

  vars_files:
    - /repositories/systemscripts/Ansible/general_vars/general_bw_vars.yml
    - /repositories/systemscripts/Ansible/general_vars/general_bw_ssl_vars.yml
    - vars/tester-container-vars.yml

  tasks:
    - name: Make the base image available locally
      docker_image:
        name: "{{ private_docker_repo }}/romana/{{ bw_tester_base_latest }}"
        source: pull

    - name: Create network
      docker_network:
        name: "{{ bw_web_network_name }}"
        ipam_config:
          - subnet: '192.168.1.0/24'
            gateway: '192.168.1.100'
            iprange: '192.168.1.0/24'
      ignore_errors: true

    - name: Create the container
      docker_container:
        image: "{{ private_docker_repo }}/romana/{{ bw_tester_base_latest }}"
        name: "bw-tester-acceptance"
        hostname: ""
        command: sleep infinity
        detach: yes
        shm_size: 1G
        stop_signal: SIGRTMIN+3
        volumes:
          - "/repositories:/repositories"
        networks:
          - name: "{{ bw_web_network_name }}"
            ipv4_address: "192.168.1.98"

- hosts: bw-tester-acceptance
  connection: docker
  gather_facts: no
  vars_files:
    - /repositories/systemscripts/Ansible/general_vars/general_bw_vars.yml
    - vars/tester-container-vars.yml

  tasks:
    - name: Copy acceptance installation files to container
      copy:
        src: files/data/
        dest: /data
        mode: u+x,g+x,o+x

    - name: Run xdebug installer script
      shell: "/data/install_xdebug.sh"
      environment: "{{ acceptance_environment }}"

    - name: Run uopz installer script
      shell: "/data/install_uopz.sh"
      environment: "{{ acceptance_environment }}"

    - name: Run composer installer script
      shell: "/data/install_composer.sh"
      environment: "{{ acceptance_environment }}"

    - name: Run test tools installer script
      shell: "/data/install_test_tools.sh"
      environment: "{{ acceptance_environment }}"

    - name: Run selenium installer script
      shell: "/data/get_selenium_stuff.sh"
      environment: "{{ acceptance_environment }}"


- hosts: localhost

  vars_files:
    - /repositories/systemscripts/Ansible/general_vars/general_bw_vars.yml
    - vars/tester-container-vars.yml

  tasks:
    - name: Stop container
      shell: "docker stop bw-tester-acceptance"

    - name: Commit the base tester 2 container
      command: 'docker commit -a "{{ docker_author }}" bw-tester-acceptance {{ private_docker_repo }}/romana/os-chromium-tester'

    - name: Push base tester 2 container image as os-chromium-tester to private registry
      shell: "docker push {{ private_docker_repo }}/romana/os-chromium-tester"
