<?xml version="1.0" encoding="UTF-8"?>

<project name="BwStats"  description="Build file for BwStats complete" default="pack">
	<import file="./bwstats_variables.xml"/>

	<!-- ============================================  -->
	<!-- Don't now if is is possible to nest build     -->
	<!-- files, therefore I'll try to do all things    -->
	<!-- around BwStats in one file, component and   -->
	<!-- and modules.                                  -->
	<!-- ============================================  -->


	<!-- ============================================  -->
	<!-- Target: prepare                               -->
	<!-- (Setting variables, delete target directory,  -->
	<!--  create target directory)                     -->
	<!-- ============================================  -->
	<target name="prepare">
		<echo msg="Set variables…" />

		<echo msg="Source dirs…" />
		<property name="source_admin_dir" value="${source_base_dir}/administrator/components/${component}" override="true" />

		<property name="source_site_dir" value="${source_base_dir}/components/${component}" override="true" />

		<property name="source_media_dir" value="${source_base_dir}/media/bw_stats" override="true" />

		<echo msg="Deleting target directories… " />
		<delete dir="/Support/Software/Joomla/${extension}/${version}" includeemptydirs="true" verbose="true" failonerror="false" />

		<echo msg="Creating target directories… " />
		<mkdir dir="${target_base_component_dir}/files/admin/language/de-DE" />
		<mkdir dir="${target_base_component_dir}/files/admin/language/en-GB" />
		<mkdir dir="${target_base_component_dir}/files/media" />
		<mkdir dir="${target_base_component_dir}/files/site/language/de-DE" />
		<mkdir dir="${target_base_component_dir}/files/site/language/en-GB" />
	</target>

	<!-- ============================================  -->
	<!-- Target: build                                 -->
	<!-- (copy files of component and modules to       -->
	<!-- target directory, empty capimgdir, move       -->
	<!-- manifest file, copy install file to base dir) -->
	<!-- ============================================  -->
	<target name="build" depends="prepare">
		<echo msg="Copying files to build directory…" />

		<echo msg="Copying component admin…" />
		<copy todir="${target_base_component_dir}/files/admin">
			<fileset dir="${source_admin_dir}">
				<include name="**" />
			</fileset>
		</copy>
		<copy todir="${target_base_component_dir}/files/admin/language/de-DE">
			<fileset dir="${source_admin_lang_dir}/de-DE">
				<include name="**/*${component}*.ini" />
			</fileset>
		</copy>
		<copy todir="${target_base_component_dir}/files/admin/language/en-GB">
			<fileset dir="${source_admin_lang_dir}/en-GB">
				<include name="**/*${component}*.ini" />
			</fileset>
		</copy>

		<echo msg="Copying component site…" />
		<copy todir="${target_base_component_dir}/files/site">
			<fileset dir="${source_site_dir}">
				<include name="**" />
			</fileset>
		</copy>
		<copy todir="${target_base_component_dir}/files/site/language/de-DE">
			<fileset dir="${source_site_lang_dir}/de-DE">
				<include name="**/*${component}*.ini" />
			</fileset>
		</copy>
		<copy todir="${target_base_component_dir}/files/site/language/en-GB">
			<fileset dir="${source_site_lang_dir}/en-GB">
				<include name="**/*${component}*.ini" />
			</fileset>
		</copy>

		<echo msg="Copying media…" />
		<copy todir="${target_base_component_dir}/files/media">
			<fileset dir="${source_media_dir}">
				<include name="**" />
			</fileset>
		</copy>

		<echo msg="Copying install script…" />
		<copy file="${target_base_component_dir}/files/admin/install.bwstats.php" tofile="${target_base_component_dir}/files/install.bwstats.php" />

		<echo msg="Moving manifest file…" />
		<move file="${target_base_component_dir}/files/admin/bwstats.xml" tofile="${target_base_component_dir}/files/bwstats.xml" />

		<echo msg="Fetch docs…" />
		<copy todir="${target_base_dir}">
			<fileset dir="/Support/Software/Joomla/${extension}/docs" expandsymboliclinks="true">
			</fileset>
		</copy>

		<echo msg="Chmod target dir…" />
		<chmod file="${target_base_dir}" mode="0777" />
	</target>

	<!-- ============================================  -->
	<!-- (DEFAULT)  Target: pack                       -->
	<!-- (Pack and upload component, modules and       -->
	<!-- (overall package)                             -->
	<!-- ============================================  -->
	<target name="pack" depends="build">
		<echo msg="Creating archive…" />

		<echo msg="…component…" />
		<zip destfile="${target_base_dir}/${component}.${version}.zip">
			<fileset dir="${target_base_component_dir}/files">
				<include name="**/**" />
			</fileset>
		</zip>

		<echo msg="…overall package…" />
		<zip destfile="${target_base_dir}/${extension}.${version}.UNZIP_FIRST.zip">
			<fileset dir="${target_base_dir}">
				<include name="*.*" />
			</fileset>
		</zip>

		<echo msg="Files copied and compressed in build directory OK!" />



		<echo msg="Upload Variable: ${upload}" />
		<if>
		<equals arg1="${upload}" arg2="1" trim="true" casesensitive="false" />
			<then>
				<echo msg="Upload to webserver…" />
				<scp
						username="${username}"
						password="${password}"
						host="${host}"
						todir="${upload_dir}">
					<fileset dir="${target_base_dir}">
						<include name="*.zip"/>
						<include name="*.pdf"/>
					</fileset>
				</scp>
				<echo msg="Upload to webserver OK!" />
			</then>
		</if>

		<move file="${target_base_dir}/${component}.${version}.zip" tofile="${target_base_component_dir}/${component}.${version}.zip" />
	</target>
</project>
