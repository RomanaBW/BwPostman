---
- hosts: localhost
  vars_files:
    - vars/vars.yml
    - vars/tests.yml

  tasks:
#    - name: Modify Vagrantfile for this tester VM
#      template:
#        src: "Vagrantfile.j2"
#        dest: "/vms-uni2/vagrant/infrastructure/farm1/J-Tester/Vagrantfile"

    - name: Setup tester VM by vagrant up
      command: 'vagrant up {{ test_suite }}'
      args:
        chdir: '/vms-uni2/vagrant/infrastructure/farm1/J-Tester'
      delegate_to: 'localhost'
#    - import_playbook: /vms-uni2/vagrant/infrastructure/farm1/J-Tester/start-tester.yml

    - name: Ensure inventory folder is present
      file:
        path: "inventory"
        state: directory
        owner: romana
        group: users
        mode: 0775

    - name: Set variable for filename
      set_fact:
        filename: "/vms-uni2/vagrant/infrastructure/farm1/J-Tester/files/{{ test_suite }}-ip.txt"

    - name: display IP of gererated VM (file content)
      debug:
        msg: "{{ lookup ('file', '{{ filename }}') }}"
      register: bw_tester_ip

    - name: Ensure inventory is created and equipped with the correct values
      template:
        src: "hosts.j2"
        dest: "inventory/hosts"

    - name: Refresh inventory
      meta: refresh_inventory

- hosts: "{{ test_suite }}"
  vars_files:
    - vars/vars.yml
    - vars/tests.yml

  tasks:
    - name: Set project dir variable
      set_fact:
        bw_project_base_dir: "{{ project_base_dir | default('/data/repositories/BwPostman/') }}"

    - name: Create test script
      template:
        src: "do-tests.sh.j2"
        dest: "/data/do-tests.sh"
        mode: 0775

    - name: Do tests
      shell: '/data/do-tests.sh'

    - name: Shutdown tester machine
      command: 'vagrant halt {{ test_suite }}'
      args:
        chdir: '/vms-uni2/vagrant/infrastructure/farm1/J-Tester'
      delegate_to: 'localhost'

    - name: Remove tester machine
      command: 'vagrant destroy {{ test_suite }}'
      args:
        chdir: '/vms-uni2/vagrant/infrastructure/farm1/J-Tester'
      delegate_to: 'localhost'
