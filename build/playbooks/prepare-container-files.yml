---
- hosts: localhost
  vars_files:
    - vars/container-vars.yml

  tasks:
    - name: Remove folders and files which are not needed
      file:
        path: "{{ project_base_dir }}/src/{{ item }}"
        state: absent
      with_items: "{{ to_delete }}"

    - name: Debug suites variable
      debug:
        msg: "{{ item }}"
      with_items: "{{ Suites }}"

    - name: set project name variable without dots
      set_fact:
        project_name_without_dots: "{{ project_name | replace('.', '') }}"

    - name: set project name variable without dots and underline
      set_fact:
        project_name_shorted: "{{ project_name_without_dots | replace('_', '') }}"

    - name: create dirs for webserver files
      file:
        path: "{{ project_base_dir }}/container_files/files-{{ item.value.suite_number }}"
        state: directory
      with_dict: "{{ Suites }}"

    - name: copy database dump
      synchronize:
        src: "{{ web_dir }}/{{ project_name_without_dots }}/backups/"
        dest: "{{ project_base_dir }}/container_files/backups"

    - name: copy webserver files to webserver 1
      synchronize:
        src: "{{ web_dir }}/{{ project_name_without_dots }}/files"
        dest: "{{ project_base_dir }}/container_files/files-1"

    - name: copy checked out extension files from to webserver 1
      synchronize:
        src: "{{ project_base_dir }}/src"
        dest: "{{ project_base_dir }}/container_files/files-1"

    - name: copy tests to webserver 1
      synchronize:
        src: "{{ project_base_dir }}/tests/"
        dest: "{{ project_base_dir }}/container_files/files-1/tests"

    - name: remove AcceptanceTesterActions.php
      file:
        path: "{{ project_base_dir }}/container_files/files-1/tests/_support/_generated/AcceptanceTesterActions.php"
        state: absent

    - name: copy webserver files from webserver 1 to webserver 2
      synchronize:
        src: "{{ project_base_dir }}/container_files/files-1/"
        dest: "{{ project_base_dir }}/container_files/files-2"

    - name: copy webserver files from webserver 1 to webserver 3
      synchronize:
        src: "{{ project_base_dir }}/container_files/files-1/"
        dest: "{{ project_base_dir }}/container_files/files-3"

    - name: ensure log folder for test results exists
      file:
        path: "{{ test_log_path}}/logs/others"
        state: directory
        mode: 0777
      with_dict: "{{ Suites }}"

    - name: ensure video folder for test results exists
      file:
        path: "{{ test_record_path }}/videos"
        state: directory
        mode: 0777
      with_dict: "{{ Suites }}"

    - name: Prepare manifest for codeception tests
      template:
        src: "codeception.container.yml.j2"
        dest: "{{ project_base_dir }}/container_files/files-{{ item.value.suite_number }}/codeception.yml"
      with_dict: "{{ Suites }}"

    - name: Prepare manifest for acceptance tests
      template:
        src: "acceptance.suite.container.yml.j2"
        dest: "{{ project_base_dir }}/container_files/files-{{ item.value.suite_number }}/tests/acceptance.suite.yml"
      with_dict: "{{ Suites }}"

    - name: Create test script
      template:
        src: "do-container-tests.sh.j2"
        dest: "{{ project_base_dir }}/container_files/files-{{ item.value.suite_number }}/do-container-tests.sh"
        mode: 0775
      with_dict: "{{ Suites }}"
